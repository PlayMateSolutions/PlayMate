import{a as B}from"./chunk-6VYIKHEF.js";import{e as x,f as v}from"./chunk-IEVPBU5H.js";import{A as b,Ra as P,Sa as D,Ta as j,c as g,j as S,x as I}from"./chunk-FQHFODV6.js";import{a as f,b as w,i as c}from"./chunk-OYAVQN5W.js";var l=(()=>{let o=class o{static openDB(){return console.log("[PaymentDB] Starting database open...",{name:o.dbName,version:o.version}),new Promise((e,r)=>{let a=indexedDB.open(o.dbName,o.version);a.onupgradeneeded=t=>{console.log("[PaymentDB] Database upgrade needed",{oldVersion:t.oldVersion,newVersion:t.newVersion});let s=t.target.result;if(console.log("[PaymentDB] Current object stores:",Array.from(s.objectStoreNames)),s.objectStoreNames.contains(o.storeName))console.log("[PaymentDB] Payments store already exists");else{console.log("[PaymentDB] Creating payments store...");try{let n=s.createObjectStore(o.storeName,{keyPath:"id"});n.createIndex("memberId","memberId",{unique:!1}),n.createIndex("date","date",{unique:!1}),n.createIndex("paymentType","paymentType",{unique:!1}),console.log("[PaymentDB] Successfully created payments store and indexes")}catch(n){throw console.error("[PaymentDB] Error creating store:",n),n}}},a.onsuccess=()=>{let t=a.result;console.log("[PaymentDB] Database opened successfully",{name:t.name,version:t.version,objectStores:Array.from(t.objectStoreNames)}),e(t)},a.onerror=()=>{console.error("[PaymentDB] Error opening database:",a.error),r(a.error)}})}static setAll(e){return c(this,null,function*(){let r=yield o.openDB();return new Promise((a,t)=>{let n=r.transaction(o.storeName,"readwrite").objectStore(o.storeName),i=n.clear();i.onerror=()=>t(i.error),i.onsuccess=()=>{let h=0,m=e.length;e.forEach(y=>{let u=n.add(y);u.onerror=()=>t(u.error),u.onsuccess=()=>{h++,h===m&&a()}})}})})}static addRecords(e){return c(this,null,function*(){let r=yield o.openDB();return new Promise((a,t)=>{let s=r.transaction(o.storeName,"readwrite"),n=s.objectStore(o.storeName),i=0,h=e.length;e.forEach(m=>{let y=n.put(m);y.onerror=()=>t(y.error),y.onsuccess=()=>{i++,i===h&&a()}}),s.onerror=()=>t(s.error)})})}static getAll(){return c(this,null,function*(){let e=yield o.openDB();return new Promise((r,a)=>{let n=e.transaction(o.storeName,"readonly").objectStore(o.storeName).getAll();n.onsuccess=()=>{let i=n.result;r(i)},n.onerror=()=>a(n.error)})})}static getLastPaymentId(){return c(this,null,function*(){try{return localStorage.getItem("playmate_lastPaymentId")}catch(e){return console.error("Error getting last payment ID from localStorage:",e),null}})}static setLastPaymentId(e){return c(this,null,function*(){try{localStorage.setItem("playmate_lastPaymentId",e)}catch(r){throw console.error("Error setting last payment ID to localStorage:",r),r}})}static getLastSyncTime(){return c(this,null,function*(){try{let e=localStorage.getItem("playmate_lastSyncTime");return e?new Date(e):null}catch(e){return console.error("Error getting last sync time from localStorage:",e),null}})}static setLastSyncTime(e){return c(this,null,function*(){try{localStorage.setItem("playmate_lastSyncTime",e.toISOString())}catch(r){throw console.error("Error setting last sync time to localStorage:",r),r}})}static clearSettings(){try{localStorage.removeItem("playmate_lastPaymentId"),localStorage.removeItem("playmate_lastSyncTime")}catch(e){console.error("Error clearing payment settings from localStorage:",e)}}};o.dbName="PlayMateDB",o.storeName="payments",o.version=3;let d=o;return d})();var R=(()=>{let o=class o{constructor(e,r,a,t){this.http=e,this.authService=r,this.clubContext=a,this.memberService=t,this.apiUrl="https://script.google.com/macros/s/AKfycbyMDOC9nYxJv8mgpqE6i6VFF3UUy9NGPSTAGxXzihntX4KLXMnFz6moNR9ZcDJm3vZ2/dev",this.paymentsSubject=new g([]),this.summarySubject=new g(null),this.loadingSubject=new g(!1),this.lastSyncSubject=new g(null),this.payments$=this.paymentsSubject.asObservable(),this.summary$=this.summarySubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.lastSync$=this.lastSyncSubject.asObservable(),this.paymentsSubject.next([]),this.summarySubject.next(null),this.loadingSubject.next(!1),this.lastSyncSubject.next(null),setTimeout(()=>this.loadCachedData(),1e3)}loadCachedData(){return c(this,null,function*(){try{console.log("Loading cached payment data...");let e=yield l.getAll(),r=yield l.getLastSyncTime();if(console.log("Cached payment records:",e.length),e.length>0){let a=yield this.linkWithMemberData(e);this.paymentsSubject.next(a),this.calculateSummary(a)}this.lastSyncSubject.next(r)}catch(e){console.error("Error loading cached data:",e)}})}initializeData(){return c(this,null,function*(){try{this.loadingSubject.next(!0),yield this.loadCachedData();let e=yield l.getLastSyncTime();(this.paymentsSubject.value.length===0||!e||new Date().getTime()-e.getTime()>5*60*1e3)&&this.syncPayments().catch(a=>{console.error("Background sync failed:",a)})}catch(e){console.error("Error initializing payment data:",e)}finally{this.loadingSubject.next(!1)}})}syncPayments(e=!1){return c(this,null,function*(){var r;try{this.loadingSubject.next(!0);let a=yield this.authService.getAuthToken(),t=this.clubContext.getSportsClubId()||"";console.log("Payment sync - Token:",a?"Present":"Missing"),console.log("Payment sync - Club ID:",t);let s={};if(!e){let u=yield l.getLastPaymentId();u&&(s.lastPaymentId=u)}let n=new D().set("action","getPayments").set("sportsClubId",t).set("authorization",a?"Bearer "+a:"");Object.keys(s).length>0&&(n=n.set("payload",JSON.stringify(s)));let h={headers:new P({"Content-Type":"text/plain;charset=utf-8"}),params:n,responseType:"json",observe:"body"},m=yield this.http.get(this.apiUrl,h).toPromise();if((m==null?void 0:m.status)==="error")throw new Error(((r=m.error)==null?void 0:r.message)||"API returned error status");if(!(m!=null&&m.data))throw new Error("No data received from API");let y=m.data;if(y&&y.length>0){let u=yield this.linkWithMemberData(y);e||!(yield l.getLastPaymentId())?yield l.setAll(u):yield l.addRecords(u);let N=Math.max(...u.map(k=>parseInt(k.id||"0"))).toString();yield l.setLastPaymentId(N),yield l.setLastSyncTime(new Date),this.lastSyncSubject.next(new Date);let p=yield l.getAll();this.paymentsSubject.next(p),this.calculateSummary(p)}}catch(a){throw console.error("Error syncing payments:",a),a}finally{this.loadingSubject.next(!1)}})}linkWithMemberData(e){return c(this,null,function*(){try{console.log("Linking payment records with member data:",e.length);let r=yield new Promise((t,s)=>{let n=setTimeout(()=>{console.warn("Member service timeout, proceeding without member data"),t([])},5e3);this.memberService.getMembers().subscribe({next:i=>{clearTimeout(n),console.log("Members fetched for linking:",i.members.length),t(i.members)},error:i=>{clearTimeout(n),console.error("Error fetching members:",i),t([])}})});console.log("Sample member IDs:",r.slice(0,3).map(t=>`[${typeof t.id}] ${t.id}`)),console.log("Sample payment member IDs:",e.slice(0,3).map(t=>`[${typeof t.memberId}] ${t.memberId}`));let a=new Map(r.map(t=>[String(t.id).trim(),t]));return e.map(t=>{let s=String(t.memberId).trim(),n=a.get(s);return n||console.log(`No member found for ID: [${typeof t.memberId}] ${t.memberId}`),w(f({},t),{memberName:n?`${n.firstName} ${n.lastName}`.trim():`Unknown Member [${s}]`})})}catch(r){return console.error("Error linking member data:",r),e}})}calculateSummary(e){if(e.length===0){this.summarySubject.next(null);return}let r={totalPayments:e.length,totalAmount:0,uniqueMembers:new Set(e.map(a=>a.memberId)).size,monthBreakdown:{}};e.forEach(a=>{r.totalAmount+=a.amount;let s=new Date(a.date).toISOString().substring(0,7);r.monthBreakdown[s]||(r.monthBreakdown[s]={count:0,amount:0}),r.monthBreakdown[s].count++,r.monthBreakdown[s].amount+=a.amount}),this.summarySubject.next(r)}refreshData(){return c(this,null,function*(){yield this.syncPayments(!0)})}loadData(){return c(this,null,function*(){yield this.initializeData()})}getPaymentsByMember(e){return this.payments$.pipe(S(r=>r.filter(a=>a.memberId===e)))}getPaymentsByDateRange(e,r){return this.payments$.pipe(S(a=>a.filter(t=>{let s=new Date(t.date);return s>=e&&s<=r})))}getPaymentSummary(){return this.summarySubject.value||{totalPayments:0,totalAmount:0,uniqueMembers:0,monthBreakdown:{}}}};o.\u0275fac=function(r){return new(r||o)(b(j),b(x),b(v),b(B))},o.\u0275prov=I({token:o,factory:o.\u0275fac,providedIn:"root"});let d=o;return d})();export{R as a};
