import{a as v}from"./chunk-SWDBMSAS.js";import{a as I}from"./chunk-UWHUA5XG.js";import{a as g}from"./chunk-ACDW2MD6.js";import{e as x,f as P}from"./chunk-HLDYDQ4G.js";import{C as u,Za as D,c as y,k as w,z as j}from"./chunk-CCDMTYGH.js";import{a as p,b as f,i}from"./chunk-OYAVQN5W.js";var m=(()=>{let o=class o{static openDB(){return console.log("[PaymentDB] Starting database open...",{name:o.dbName,version:g.version}),new Promise((t,e)=>{let a=indexedDB.open(o.dbName,g.version);a.onupgradeneeded=r=>{let n=r.target.result;g.onUpgrade(n)},a.onsuccess=()=>{let r=a.result;console.log("[PaymentDB] Database opened successfully",{name:r.name,version:r.version,objectStores:Array.from(r.objectStoreNames)}),t(r)},a.onerror=()=>{console.error("[PaymentDB] Error opening database:",a.error),e(a.error)}})}static setAll(t){return i(this,null,function*(){let e=yield o.openDB();return new Promise((a,r)=>{let s=e.transaction(o.storeName,"readwrite").objectStore(o.storeName),c=s.clear();c.onerror=()=>r(c.error),c.onsuccess=()=>{let d=0,b=t.length;t.forEach(h=>{let S=s.add(h);S.onerror=()=>r(S.error),S.onsuccess=()=>{d++,d===b&&a()}})}})})}static addRecords(t){return i(this,null,function*(){let e=yield o.openDB();return new Promise((a,r)=>{let n=e.transaction(o.storeName,"readwrite"),s=n.objectStore(o.storeName),c=0,d=t.length;t.forEach(b=>{let h=s.put(b);h.onerror=()=>r(h.error),h.onsuccess=()=>{c++,c===d&&a()}}),n.onerror=()=>r(n.error)})})}static getAll(){return i(this,null,function*(){let t=yield o.openDB();return new Promise((e,a)=>{let s=t.transaction(o.storeName,"readonly").objectStore(o.storeName).getAll();s.onsuccess=()=>{let c=s.result;e(c)},s.onerror=()=>a(s.error)})})}static getLastPaymentId(){return i(this,null,function*(){try{return localStorage.getItem("playmate_lastPaymentId")}catch(t){return console.error("Error getting last payment ID from localStorage:",t),null}})}static setLastPaymentId(t){return i(this,null,function*(){try{localStorage.setItem("playmate_lastPaymentId",t)}catch(e){throw console.error("Error setting last payment ID to localStorage:",e),e}})}static getLastSyncTime(){return i(this,null,function*(){try{let t=localStorage.getItem("playmate_lastSyncTime");return t?new Date(t):null}catch(t){return console.error("Error getting last sync time from localStorage:",t),null}})}static setLastSyncTime(t){return i(this,null,function*(){try{localStorage.setItem("playmate_lastSyncTime",t.toISOString())}catch(e){throw console.error("Error setting last sync time to localStorage:",e),e}})}static clearSettings(){try{localStorage.removeItem("playmate_lastPaymentId"),localStorage.removeItem("playmate_lastSyncTime")}catch(t){console.error("Error clearing payment settings from localStorage:",t)}}};o.dbName="PlayMateDB",o.storeName="payments",o.version=3;let l=o;return l})();var O=(()=>{let o=class o{constructor(t,e,a,r,n){this.http=t,this.authService=e,this.clubContext=a,this.memberService=r,this.googleSheetService=n,this.apiUrl="https://script.google.com/macros/s/AKfycbyMDOC9nYxJv8mgpqE6i6VFF3UUy9NGPSTAGxXzihntX4KLXMnFz6moNR9ZcDJm3vZ2/dev",this.paymentsSubject=new y([]),this.summarySubject=new y(null),this.loadingSubject=new y(!1),this.lastSyncSubject=new y(null),this.payments$=this.paymentsSubject.asObservable(),this.summary$=this.summarySubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.lastSync$=this.lastSyncSubject.asObservable(),this.paymentsSubject.next([]),this.summarySubject.next(null),this.loadingSubject.next(!1),this.lastSyncSubject.next(null),setTimeout(()=>this.loadCachedData(),1e3)}loadCachedData(){return i(this,null,function*(){try{console.log("Loading cached payment data...");let t=yield m.getAll(),e=yield m.getLastSyncTime();if(console.log("Cached payment records:",t.length),t.length>0){let a=yield this.linkWithMemberData(t);this.paymentsSubject.next(a),this.calculateSummary(a)}this.lastSyncSubject.next(e)}catch(t){console.error("Error loading cached data:",t)}})}initializeData(){return i(this,null,function*(){try{this.loadingSubject.next(!0),yield this.loadCachedData();let t=yield m.getLastSyncTime();(this.paymentsSubject.value.length===0||!t||new Date().getTime()-t.getTime()>5*60*1e3)&&this.syncPayments(!0).catch(a=>{console.error("Background sync failed:",a)})}catch(t){console.error("Error initializing payment data:",t)}finally{this.loadingSubject.next(!1)}})}syncPayments(t=!1){return i(this,null,function*(){try{this.loadingSubject.next(!0),console.log("Fetching payment data from Google Sheets...");let e=yield this.googleSheetService.RefreshPaymentsData();if(e&&e.length>0){let a=e.map(c=>f(p({},c),{amount:Number(c.amount)||0})),r=yield this.linkWithMemberData(a);t||!(yield m.getLastPaymentId())?yield m.setAll(r):yield m.addRecords(r);let n=Math.max(...r.map(c=>parseInt(c.id||"0"))).toString();yield m.setLastPaymentId(n),yield m.setLastSyncTime(new Date),this.lastSyncSubject.next(new Date);let s=yield m.getAll();this.paymentsSubject.next(s),this.calculateSummary(s)}}catch(e){throw console.error("Error syncing payments:",e),e}finally{this.loadingSubject.next(!1)}})}linkWithMemberData(t){return i(this,null,function*(){try{console.log("Linking payment records with member data:",t.length);let e=yield new Promise((r,n)=>{let s=setTimeout(()=>{console.warn("Member service timeout, proceeding without member data"),r([])},5e3);this.memberService.getMembers().subscribe({next:c=>{clearTimeout(s),console.log("Members fetched for linking:",c.members.length),r(c.members)},error:c=>{clearTimeout(s),console.error("Error fetching members:",c),r([])}})}),a=new Map(e.map(r=>[String(r.id).trim(),r]));return t.map(r=>{let n=String(r.memberId).trim(),s=a.get(n);return s||console.log(`No member found for ID: [${typeof r.memberId}] ${r.memberId}`),f(p({},r),{memberName:s?`${s.firstName} ${s.lastName}`.trim():`Unknown Member [${n}]`})})}catch(e){return console.error("Error linking member data:",e),t}})}calculateSummary(t){if(t.length===0){this.summarySubject.next(null);return}let e={totalPayments:t.length,totalAmount:0,uniqueMembers:new Set(t.map(a=>a.memberId)).size,monthBreakdown:{}};t.forEach(a=>{e.totalAmount+=a.amount;let n=new Date(a.date).toISOString().substring(0,7);e.monthBreakdown[n]||(e.monthBreakdown[n]={count:0,amount:0}),e.monthBreakdown[n].count++,e.monthBreakdown[n].amount+=a.amount}),console.log("Calculated payment summary:",e),this.summarySubject.next(e)}refreshData(){return i(this,null,function*(){yield this.syncPayments(!0),this.clubContext.setLastPaymentRefresh(new Date)})}loadData(){return i(this,null,function*(){yield this.initializeData()})}getPaymentsByMember(t){return this.payments$.pipe(w(e=>e.filter(a=>String(a.memberId)===t)))}getPaymentsByDateRange(t,e){return this.payments$.pipe(w(a=>a.filter(r=>{let n=new Date(r.date);return n>=t&&n<=e})))}getPaymentSummary(){return this.summarySubject.value||{totalPayments:0,totalAmount:0,uniqueMembers:0,monthBreakdown:{}}}};o.\u0275fac=function(e){return new(e||o)(u(D),u(x),u(P),u(v),u(I))},o.\u0275prov=j({token:o,factory:o.\u0275fac,providedIn:"root"});let l=o;return l})();export{O as a};
