import{a as I,e as C,f as N}from"./chunk-IEVPBU5H.js";import{A as b,Ra as d,Sa as f,Ta as v,f as p,g as x,j as i,q as l,v as h,x as j}from"./chunk-FQHFODV6.js";import{a as g,b as S,i as m}from"./chunk-OYAVQN5W.js";var w=(()=>{let r=class r{static openDB(){return new Promise((s,o)=>{let a=indexedDB.open(r.dbName,r.version);a.onupgradeneeded=n=>{let t=n.target.result;if(t.objectStoreNames.contains(r.storeName)||t.createObjectStore(r.storeName,{keyPath:"id"}),!t.objectStoreNames.contains("attendance")){let e=t.createObjectStore("attendance",{keyPath:"id"});e.createIndex("memberId","memberId",{unique:!1}),e.createIndex("date","date",{unique:!1}),e.createIndex("membershipStatus","membershipStatus",{unique:!1}),e.createIndex("dateRange",["date","memberId"],{unique:!1})}t.objectStoreNames.contains("attendanceSettings")||t.createObjectStore("attendanceSettings",{keyPath:"key"})},a.onsuccess=()=>s(a.result),a.onerror=()=>o(a.error)})}static getAll(){return m(this,null,function*(){let s=yield r.openDB();return new Promise((o,a)=>{let e=s.transaction(r.storeName,"readonly").objectStore(r.storeName).getAll();e.onsuccess=()=>o(e.result),e.onerror=()=>a(e.error)})})}static setAll(s){return m(this,null,function*(){let o=yield r.openDB();return new Promise((a,n)=>{var c;let t=o.transaction(r.storeName,"readwrite"),e=t.objectStore(r.storeName);e.clear();for(let y of s){let T=S(g({},y),{id:(c=y.ID)!=null?c:y.id});e.put(T)}t.oncomplete=()=>a(),t.onerror=()=>n(t.error)})})}};r.dbName="PlayMateDB",r.storeName="members",r.version=3;let u=r;return u})();var H=(()=>{let r=class r{constructor(s,o,a){this.http=s,this.authService=o,this.clubContext=a,this.apiUrl=I.apiUrl}getRequestPayload(a){return m(this,arguments,function*(s,o={}){let n=yield this.authService.getAuthToken();return{action:s,payload:o,authorization:n?"Bearer "+n:void 0}})}getMembers(){return p(w.getAll()).pipe(i(s=>({members:s,isFresh:!1})),l(()=>x({members:[],isFresh:!1})))}refreshMembers(){return p(this.authService.getAuthToken()).pipe(h(s=>{let o=this.clubContext.getSportsClubId()||"",a=new f().set("sportsClubId",o).set("action","getMembers").set("authorization",s?"Bearer "+s:""),t={headers:new d({"Content-Type":"text/plain;charset=utf-8"}),params:a,responseType:"json",observe:"body"};return this.http.get(this.apiUrl,t).pipe(i(e=>{var c;if(e.status==="error")throw new Error((c=e.error)==null?void 0:c.message);return e.data||[]}),h(e=>p(w.setAll(e)).pipe(i(()=>e))),i(e=>({members:e,isFresh:!0})),l(e=>{throw console.error("Error fetching members:",e),e}))}))}searchMembers(s){return p(this.authService.getAuthToken()).pipe(h(o=>{let a=new f().set("action","getMembers").set("payload",JSON.stringify({filters:{searchTerm:s}})).set("authorization",o?"Bearer "+o:""),t={headers:new d({"Content-Type":"text/plain;charset=utf-8"}),params:a,responseType:"json",observe:"body"};return this.http.get(this.apiUrl,t).pipe(i(e=>{var c;if(e.status==="error")throw new Error((c=e.error)==null?void 0:c.message);return e.data||[]}),l(e=>{throw console.error("Error searching members:",e),e}))}))}addMember(s){return p(this.authService.getAuthToken()).pipe(h(o=>{if(!o)throw new Error("No valid auth token");let a=new f().set("sportsClubId",this.clubContext.getSportsClubId()||"").set("action","addMember").set("authorization","Bearer "+o),t={headers:new d({"Content-Type":"text/plain;charset=utf-8"}),params:a,responseType:"json",observe:"body"};return this.http.post(this.apiUrl,s,t).pipe(i(e=>{if(e.status==="success"&&e.data)return e.data;throw new Error("Failed to add member")}))}))}updateMember(s){return p(this.getRequestPayload("updateMember",s)).pipe(h(o=>{let n={headers:new d({"Content-Type":"text/plain;charset=utf-8"}),responseType:"json",observe:"body"};return this.http.post(this.apiUrl,o,n).pipe(i(t=>{var e;if(t.status==="error")throw new Error((e=t.error)==null?void 0:e.message);return t.data}))}))}deleteMember(s){return p(this.getRequestPayload("deleteMember",{memberId:s})).pipe(h(o=>{let n={headers:new d({"Content-Type":"text/plain;charset=utf-8"}),responseType:"json",observe:"body"};return this.http.post(this.apiUrl,o,n).pipe(i(t=>{var e;if(t.status==="error")throw new Error((e=t.error)==null?void 0:e.message);return t.data||!1}))}))}};r.\u0275fac=function(o){return new(o||r)(b(v),b(C),b(N))},r.\u0275prov=j({token:r,factory:r.\u0275fac,providedIn:"root"});let u=r;return u})();export{H as a};
