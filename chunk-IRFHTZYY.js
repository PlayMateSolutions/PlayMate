import{a as we}from"./chunk-HNJJMWZ7.js";import{e as Ie,f as ve}from"./chunk-DSDURIJA.js";import"./chunk-T47TWMLD.js";import{E as xe,a as Pe}from"./chunk-57T6L74Z.js";import{$ as s,$b as pe,A as C,Aa as v,Ba as j,G as L,Gb as Z,H as q,Ha as V,Hb as Y,Ia as G,Ib as ee,Jb as te,Ka as H,Kb as ne,La as R,Lb as ae,Ma as K,Mb as ie,Na as Q,Nb as re,Pb as oe,Q as m,Qa as J,R as M,Ra as X,Sa as W,Sb as se,T as z,Vb as ce,Wb as le,X as P,Yb as me,Z as y,Zb as de,aa as l,ac as ue,ba as E,c as D,dc as ye,fa as F,ha as B,ia as _,ic as ge,j as T,jc as he,ra as p,rc as fe,sa as k,ta as x,tc as be,ua as U,vc as Se,x as A,za as f}from"./chunk-M53L3PTZ.js";import"./chunk-GRX4ZZSO.js";import"./chunk-7KGURMOZ.js";import"./chunk-Y2YV2HED.js";import"./chunk-EDCKRRWH.js";import"./chunk-SPCCATGZ.js";import"./chunk-YKMIF4NY.js";import"./chunk-YVBCZ55L.js";import"./chunk-4U6PRYVA.js";import"./chunk-FXFZIWDD.js";import"./chunk-CSG5OQLY.js";import"./chunk-VMHM3MLJ.js";import"./chunk-D5MTWDX2.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{a as O,b as $,i as u}from"./chunk-OYAVQN5W.js";var b=(()=>{let a=class a{static openDB(){return console.log("[PaymentDB] Starting database open...",{name:a.dbName,version:a.version}),new Promise((e,t)=>{let n=indexedDB.open(a.dbName,a.version);n.onupgradeneeded=i=>{console.log("[PaymentDB] Database upgrade needed",{oldVersion:i.oldVersion,newVersion:i.newVersion});let o=i.target.result;if(console.log("[PaymentDB] Current object stores:",Array.from(o.objectStoreNames)),o.objectStoreNames.contains(a.storeName))console.log("[PaymentDB] Payments store already exists");else{console.log("[PaymentDB] Creating payments store...");try{let c=o.createObjectStore(a.storeName,{keyPath:"id"});c.createIndex("memberId","memberId",{unique:!1}),c.createIndex("date","date",{unique:!1}),c.createIndex("paymentType","paymentType",{unique:!1}),console.log("[PaymentDB] Successfully created payments store and indexes")}catch(c){throw console.error("[PaymentDB] Error creating store:",c),c}}},n.onsuccess=()=>{let i=n.result;console.log("[PaymentDB] Database opened successfully",{name:i.name,version:i.version,objectStores:Array.from(i.objectStoreNames)}),e(i)},n.onerror=()=>{console.error("[PaymentDB] Error opening database:",n.error),t(n.error)}})}static setAll(e){return u(this,null,function*(){let t=yield a.openDB();return new Promise((n,i)=>{let c=t.transaction(a.storeName,"readwrite").objectStore(a.storeName),g=c.clear();g.onerror=()=>i(g.error),g.onsuccess=()=>{let w=0,h=e.length;e.forEach(I=>{let S=c.add(I);S.onerror=()=>i(S.error),S.onsuccess=()=>{w++,w===h&&n()}})}})})}static addRecords(e){return u(this,null,function*(){let t=yield a.openDB();return new Promise((n,i)=>{let o=t.transaction(a.storeName,"readwrite"),c=o.objectStore(a.storeName),g=0,w=e.length;e.forEach(h=>{let I=c.put(h);I.onerror=()=>i(I.error),I.onsuccess=()=>{g++,g===w&&n()}}),o.onerror=()=>i(o.error)})})}static getAll(){return u(this,null,function*(){let e=yield a.openDB();return new Promise((t,n)=>{let c=e.transaction(a.storeName,"readonly").objectStore(a.storeName).getAll();c.onsuccess=()=>{let g=c.result;t(g)},c.onerror=()=>n(c.error)})})}static getLastPaymentId(){return u(this,null,function*(){try{return localStorage.getItem("playmate_lastPaymentId")}catch(e){return console.error("Error getting last payment ID from localStorage:",e),null}})}static setLastPaymentId(e){return u(this,null,function*(){try{localStorage.setItem("playmate_lastPaymentId",e)}catch(t){throw console.error("Error setting last payment ID to localStorage:",t),t}})}static getLastSyncTime(){return u(this,null,function*(){try{let e=localStorage.getItem("playmate_lastSyncTime");return e?new Date(e):null}catch(e){return console.error("Error getting last sync time from localStorage:",e),null}})}static setLastSyncTime(e){return u(this,null,function*(){try{localStorage.setItem("playmate_lastSyncTime",e.toISOString())}catch(t){throw console.error("Error setting last sync time to localStorage:",t),t}})}static clearSettings(){try{localStorage.removeItem("playmate_lastPaymentId"),localStorage.removeItem("playmate_lastSyncTime")}catch(e){console.error("Error clearing payment settings from localStorage:",e)}}};a.dbName="PlayMateDB",a.storeName="payments",a.version=3;let r=a;return r})();var _e=(()=>{let a=class a{constructor(e,t,n,i){this.http=e,this.authService=t,this.clubContext=n,this.memberService=i,this.apiUrl="https://script.google.com/macros/s/AKfycbyMDOC9nYxJv8mgpqE6i6VFF3UUy9NGPSTAGxXzihntX4KLXMnFz6moNR9ZcDJm3vZ2/dev",this.paymentsSubject=new D([]),this.summarySubject=new D(null),this.loadingSubject=new D(!1),this.lastSyncSubject=new D(null),this.payments$=this.paymentsSubject.asObservable(),this.summary$=this.summarySubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.lastSync$=this.lastSyncSubject.asObservable(),this.paymentsSubject.next([]),this.summarySubject.next(null),this.loadingSubject.next(!1),this.lastSyncSubject.next(null),setTimeout(()=>this.loadCachedData(),1e3)}loadCachedData(){return u(this,null,function*(){try{console.log("Loading cached payment data...");let e=yield b.getAll(),t=yield b.getLastSyncTime();console.log("Cached payment records:",e.length),e.length>0&&(this.paymentsSubject.next(e),this.calculateSummary(e)),this.lastSyncSubject.next(t)}catch(e){console.error("Error loading cached data:",e)}})}initializeData(){return u(this,null,function*(){try{this.loadingSubject.next(!0),yield this.loadCachedData();let e=yield b.getLastSyncTime();(this.paymentsSubject.value.length===0||!e||new Date().getTime()-e.getTime()>5*60*1e3)&&this.syncPayments().catch(n=>{console.error("Background sync failed:",n)})}catch(e){console.error("Error initializing payment data:",e)}finally{this.loadingSubject.next(!1)}})}syncPayments(e=!1){return u(this,null,function*(){var t;try{this.loadingSubject.next(!0);let n=yield this.authService.getAuthToken(),i=this.clubContext.getSportsClubId()||"";console.log("Payment sync - Token:",n?"Present":"Missing"),console.log("Payment sync - Club ID:",i);let o={};if(!e){let S=yield b.getLastPaymentId();S&&(o.lastPaymentId=S)}let c=new X().set("action","getPayments").set("sportsClubId",i).set("authorization",n?"Bearer "+n:"");Object.keys(o).length>0&&(c=c.set("payload",JSON.stringify(o)));let w={headers:new J({"Content-Type":"text/plain;charset=utf-8"}),params:c,responseType:"json",observe:"body"},h=yield this.http.get(this.apiUrl,w).toPromise();if((h==null?void 0:h.status)==="error")throw new Error(((t=h.error)==null?void 0:t.message)||"API returned error status");if(!(h!=null&&h.data))throw new Error("No data received from API");let I=h.data;if(I&&I.length>0){let S=yield this.linkWithMemberData(I);e||!(yield b.getLastPaymentId())?yield b.setAll(S):yield b.addRecords(S);let De=Math.max(...S.map(Ce=>parseInt(Ce.id||"0"))).toString();yield b.setLastPaymentId(De),yield b.setLastSyncTime(new Date),this.lastSyncSubject.next(new Date);let N=yield b.getAll();this.paymentsSubject.next(N),this.calculateSummary(N)}}catch(n){throw console.error("Error syncing payments:",n),n}finally{this.loadingSubject.next(!1)}})}linkWithMemberData(e){return u(this,null,function*(){try{console.log("Linking payment records with member data:",e.length);let t=yield new Promise((i,o)=>{let c=setTimeout(()=>{console.warn("Member service timeout, proceeding without member data"),i([])},5e3);this.memberService.getMembers().subscribe({next:g=>{clearTimeout(c),console.log("Members fetched for linking:",g.members.length),i(g.members)},error:g=>{clearTimeout(c),console.error("Error fetching members:",g),i([])}})}),n=new Map(t.map(i=>[i.id,i]));return e.map(i=>{let o=n.get(i.memberId);return $(O({},i),{memberName:o?`${o.firstName} ${o.lastName}`.trim():"Unknown Member"})})}catch(t){return console.error("Error linking member data:",t),e}})}calculateSummary(e){if(e.length===0){this.summarySubject.next(null);return}let t={totalPayments:e.length,totalAmount:0,uniqueMembers:new Set(e.map(n=>n.memberId)).size,monthBreakdown:{}};e.forEach(n=>{t.totalAmount+=n.amount;let o=new Date(n.date).toISOString().substring(0,7);t.monthBreakdown[o]||(t.monthBreakdown[o]={count:0,amount:0}),t.monthBreakdown[o].count++,t.monthBreakdown[o].amount+=n.amount}),this.summarySubject.next(t)}refreshData(){return u(this,null,function*(){yield this.syncPayments(!0)})}loadData(){return u(this,null,function*(){yield this.initializeData()})}getPaymentsByMember(e){return this.payments$.pipe(T(t=>t.filter(n=>n.memberId===e)))}getPaymentsByDateRange(e,t){return this.payments$.pipe(T(n=>n.filter(i=>{let o=new Date(i.date);return o>=e&&o<=t})))}getPaymentSummary(){return this.summarySubject.value||{totalPayments:0,totalAmount:0,uniqueMembers:0,monthBreakdown:{}}}};a.\u0275fac=function(t){return new(t||a)(C(W),C(Ie),C(ve),C(we))},a.\u0275prov=A({token:a,factory:a.\u0275fac,providedIn:"root"});let r=a;return r})();function Be(r,a){if(r&1&&(s(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),p(3,"Payment Statistics"),l(),s(4,"ion-card-subtitle"),p(5),f(6,"async"),l()(),s(7,"ion-card-content")(8,"div",10)(9,"div",11)(10,"strong"),p(11,"Total Amount"),l(),s(12,"span"),p(13),f(14,"async"),f(15,"number"),l()(),s(16,"div",11)(17,"strong"),p(18,"Unique Members"),l(),s(19,"span"),p(20),f(21,"async"),l()()()()()),r&2){let d,e,t,n=_();m(5),x("",((d=v(6,3,n.summary$))==null?null:d.totalPayments)||0," total payments"),m(8),x("\u20B9",j(15,7,((e=v(14,5,n.summary$))==null?null:e.totalAmount)||0,"1.0-0"),""),m(7),k(((t=v(21,10,n.summary$))==null?null:t.uniqueMembers)||0)}}function Te(r,a){r&1&&(s(0,"div",12)(1,"ion-card")(2,"ion-card-header")(3,"ion-card-title"),E(4,"ion-skeleton-text",13),l()(),s(5,"ion-card-content"),E(6,"ion-skeleton-text",14)(7,"ion-skeleton-text",15),l()()()),r&2&&(m(4),y("animated",!0),m(2),y("animated",!0),m(),y("animated",!0))}function Me(r,a){if(r&1&&(s(0,"ion-badge",27),p(1),l()),r&2){let d=_().$implicit;m(),x(" ",d.status," ")}}function ke(r,a){if(r&1){let d=F();s(0,"ion-item",22),B("click",function(){let t=L(d).$implicit,n=_(3);return q(n.showPaymentDetails(t))}),s(1,"ion-label")(2,"h2"),p(3),s(4,"ion-note",23),p(5),l()(),s(6,"ion-note",24),p(7),f(8,"date"),P(9,Me,2,1,"ion-badge",25),l()(),s(10,"ion-note",26),p(11),f(12,"number"),l()()}if(r&2){let d=a.$implicit;m(3),x("",d.memberName||"Unknown Member"," "),m(2),x("#",d.memberId,""),m(2),U(" ",j(8,6,d.date,"mediumDate")," \xB7 ",d.paymentType," "),m(2),y("ngIf",d.status!=="active"),m(2),x(" \u20B9",j(12,9,d.amount,"1.0-0")," ")}}function Ne(r,a){if(r&1&&(s(0,"div",18)(1,"ion-item-divider",19)(2,"ion-label"),p(3),l(),s(4,"ion-note",2),p(5),f(6,"number"),l()(),s(7,"ion-list",20),P(8,ke,13,12,"ion-item",21),l()()),r&2){let d=a.$implicit;m(3),k(d.formattedDate),m(2),x("\u20B9",j(6,3,d.total,"1.0-0"),""),m(3),y("ngForOf",d.payments)}}function Oe(r,a){if(r&1&&(s(0,"div",16),P(1,Ne,9,6,"div",17),l()),r&2){let d=_();m(),y("ngForOf",d.displayedGroups)}}function $e(r,a){r&1&&(s(0,"p"),p(1,"There are no payment records."),l())}function Ae(r,a){r&1&&(s(0,"p"),p(1,"No payments match your search criteria."),l())}function Le(r,a){if(r&1&&(s(0,"ion-card",28)(1,"ion-card-content",29)(2,"ion-label",24)(3,"h2"),p(4,"No Payments Found"),l(),P(5,$e,2,0,"p",6)(6,Ae,2,0,"p",6),l()()()),r&2){let d=_();m(5),y("ngIf",!d.searchQuery),m(),y("ngIf",d.searchQuery)}}var tt=(()=>{let a=class a{constructor(e,t){this.paymentService=e,this.toastController=t,this.loading$=this.paymentService.loading$,this.summary$=this.paymentService.summary$,this.displayedGroups=[],this.searchQuery="",this.refreshing=!1,Pe({refresh:xe})}ngOnInit(){this.paymentService.payments$.subscribe(e=>{e&&this.processPayments(e)}),this.paymentService.loadData().catch(e=>{console.error("Error initializing payments:",e)})}processPayments(e){let t=new Map;e.forEach(n=>{let i=new Date(n.date),o=i.toISOString().substring(0,7);t.has(o)||t.set(o,{month:o,formattedDate:i.toLocaleDateString("en-US",{month:"long",year:"numeric"}),payments:[],total:0});let c=t.get(o);c.payments.push(n),c.total+=n.amount}),this.displayedGroups=Array.from(t.values()).sort((n,i)=>i.month.localeCompare(n.month))}refreshPayments(){return u(this,null,function*(){if(!this.refreshing)try{this.refreshing=!0,console.log("Refreshing payment data..."),yield this.paymentService.loadData(),console.log("Payment data refreshed successfully"),yield(yield this.toastController.create({message:"Payment data refreshed successfully",duration:2e3,color:"success"})).present()}catch(e){console.error("Error refreshing payment data:",e),yield(yield this.toastController.create({message:"Failed to refresh payment data",duration:2e3,color:"danger"})).present()}finally{this.refreshing=!1}})}onSearchChange(e){var t;this.searchQuery=((t=e.detail.value)==null?void 0:t.toLowerCase())||""}showPaymentDetails(e){console.log("Show payment details:",e)}};a.\u0275fac=function(t){return new(t||a)(M(_e),M(fe))},a.\u0275cmp=z({type:a,selectors:[["app-payments"]],decls:20,vars:14,consts:[["color","primary"],["slot","start"],["slot","end"],[3,"click","disabled"],["slot","icon-only","name","refresh"],["placeholder","Search payments",3,"ionInput","debounce"],[4,"ngIf"],["class","ion-padding",4,"ngIf"],["class","payment-list",4,"ngIf"],["class","no-data-card",4,"ngIf"],[1,"stats-grid"],[1,"stat-item"],[1,"ion-padding"],[2,"width","60%",3,"animated"],[2,"width","100%",3,"animated"],[2,"width","80%",3,"animated"],[1,"payment-list"],["class","date-group",4,"ngFor","ngForOf"],[1,"date-group"],["sticky","true","color","light"],["lines","full"],["class","payment-item",3,"click",4,"ngFor","ngForOf"],[1,"payment-item",3,"click"],["color","medium",1,"id-note"],["color","medium"],["color","danger","class","status-badge",4,"ngIf"],["slot","end","color","success",1,"amount-note"],["color","danger",1,"status-badge"],[1,"no-data-card"],[1,"ion-text-center"]],template:function(t,n){t&1&&(s(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-buttons",1),E(3,"ion-menu-button"),l(),s(4,"ion-title"),p(5,"Payments"),l(),s(6,"ion-buttons",2)(7,"ion-button",3),B("click",function(){return n.refreshPayments()}),E(8,"ion-icon",4),l()()(),s(9,"ion-toolbar")(10,"ion-searchbar",5),B("ionInput",function(o){return n.onSearchChange(o)}),l()()(),s(11,"ion-content"),P(12,Be,22,12,"ion-card",6),f(13,"async"),P(14,Te,8,3,"div",7),f(15,"async"),P(16,Oe,2,1,"div",8),f(17,"async"),P(18,Le,7,2,"ion-card",9),f(19,"async"),l()),t&2&&(m(7),y("disabled",n.refreshing),m(3),y("debounce",500),m(2),y("ngIf",!v(13,6,n.loading$)),m(2),y("ngIf",v(15,8,n.loading$)),m(2),y("ngIf",!v(17,10,n.loading$)&&n.displayedGroups.length>0),m(2),y("ngIf",!v(19,12,n.loading$)&&n.displayedGroups.length===0))},dependencies:[Q,V,G,H,K,R,se,he,ge,oe,de,ce,me,te,ae,ne,re,ie,Se,Z,ue,ee,pe,ye,le,Y,be],styles:[".stats-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:8px 0}.stat-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;text-align:center}.stat-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:.9rem;color:var(--ion-color-medium);margin-bottom:4px}.stat-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:1.2rem;font-weight:700}.id-note[_ngcontent-%COMP%]{margin-left:8px;font-size:.8rem}.amount-note[_ngcontent-%COMP%]{font-weight:700;font-size:1.1rem}.status-badge[_ngcontent-%COMP%]{margin-left:8px;text-transform:capitalize}"]});let r=a;return r})();export{tt as PaymentsPage};
