import{e as g,f}from"./chunk-HLDYDQ4G.js";import{C as d,Za as u,h as m,k as h,s as p,z as l}from"./chunk-CCDMTYGH.js";import{i as o}from"./chunk-OYAVQN5W.js";var y=(()=>{let n=class n{constructor(t){this.http=t,this.defaultActiveValues=["true","1","yes"],this.oauthToken="",this.spreadsheetId=""}get(t,e){return this.getRows(t).pipe(h(s=>this.rowsToEntries(s).map(a=>this.getObjectFromEntry(a,e))))}getActive(t,e,s="is_active",a=null){return a===null?a=this.defaultActiveValues:Array.isArray(a)||(a=[a]),this.getRows(t).pipe(h(i=>this.rowsToEntries(i).filter(r=>a.includes(r[s].toLowerCase())).map(r=>this.getObjectFromEntry(r,e))))}getSpreadsheetUrl(t){return"https://sheets.googleapis.com/v4/spreadsheets/"+this.spreadsheetId+"/values/"+encodeURI(t)}getRows(t){let e=this.getSpreadsheetUrl(t),s={Authorization:`Bearer ${this.oauthToken}`};return this.http.get(e,{headers:s}).pipe(h(a=>a.values),p(this.handleError))}rowsToEntries(t){let e=t[0].map(this.cleanColumnName);return t.slice(1).map(s=>e.reduce((a,i,r)=>(a[i]=s.length>r?s[r]:"",a),{}))}cleanColumnName(t){return t.trim()}arrayToObject(t){return t.reduce((e,s)=>(e[s]=s,e),{})}getObjectFromEntry(t,e){return Array.isArray(e)&&(e=this.arrayToObject(e)),this.getObjectFromEntryObject(t,e)}getObjectFromEntryObject(t,e,s=""){let a={};for(let i in Object(e))if(e.hasOwnProperty(i)&&!["_prefix","_listField"].includes(i))if(typeof e[i]=="string")a[i]=this.getValueFromEntry(t,s+e[i]);else if(typeof e[i]=="object"){let r="";e[i].hasOwnProperty("_prefix")&&(r=e[i]._prefix),e[i]._listField?a[i]=this.getListFromEntry(t,s+r):a[i]=this.getObjectFromEntryObject(t,e[i],s+r)}else console.log(`Unknown type for ${i}`);return a}getValueFromEntry(t,e){return e=this.cleanColumnName(e),t.hasOwnProperty(e)?t[e]:null}getListFromEntry(t,e){let s=[],a=1,i=this.getValueFromEntry(t,`${e}${a}`);for(;i!==null;)s.push(i),a++,i=this.getValueFromEntry(t,`${e}${a}`);return s}handleError(t){return t.error instanceof ErrorEvent?console.error("An error occurred:",t.error.message):console.error(`Backend returned code ${t.status}, body was: ${t.error}`),m("Something bad happened; please try again later.")}};n.\u0275fac=function(e){return new(e||n)(d(u))},n.\u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"});let c=n;return c})();var j=(()=>{let n=class n{constructor(t,e,s){this.clubContextService=t,this.authService=e,this.googleSheetsDbService=s,this.memberAttributesMapping={id:"id",firstName:"firstName",lastName:"lastName",email:"email",phone:"phone",place:"place",joinDate:"joinDate",status:"status",expiryDate:"expiryDate",notes:"notes",dateOfBirth:"dateOfBirth",gender:"gender"},this.attendanceAttributesMapping={id:"id",memberId:"memberId",date:"date",checkInTime:"checkInTime",checkOutTime:"checkOutTime",membershipStatus:"membershipStatus",daysToExpiry:"daysToExpiry",duration:"duration",notes:"notes"},this.paymentsAttributesMapping={id:"id",memberId:"memberId",date:"date",amount:"amount",paymentType:"paymentType",periodStart:"periodStart",periodEnd:"periodEnd",status:"status",notes:"notes",transactionId:"transactionId"},this.expensesAttributesMapping={id:"id",date:"date",category:"category",notes:"notes",amount:"amount",paymentType:"paymentType",payee:"payee",transactionId:"transactionId",recordedBy:"recordedBy"},this.clubSettingsAttributesMapping={settings:"Setting",value:"Value"},this.initializeSpreadsheet()}initializeSpreadsheet(){return o(this,null,function*(){var s;let t=yield this.authService.getSession().then(a=>a==null?void 0:a.accessToken);t?this.googleSheetsDbService.oauthToken=t:console.error("Failed to obtain OAuth token for Google Sheets API.");let e=(s=this.clubContextService.getSpreadSheet())==null?void 0:s.id;e?this.googleSheetsDbService.spreadsheetId=e:console.error("No spreadsheet ID found in club context.")})}RefreshMembersData(){return o(this,null,function*(){return new Promise((t,e)=>{this.googleSheetsDbService.get("Members",this.memberAttributesMapping).subscribe({next:s=>{t(s)},error:s=>{e(s)}})})})}RefreshAttendanceData(){return o(this,null,function*(){return new Promise((t,e)=>{this.googleSheetsDbService.get("Attendance",this.attendanceAttributesMapping).subscribe({next:s=>{t(s)},error:s=>{e(s)}})})})}RefreshPaymentsData(){return o(this,null,function*(){return new Promise((t,e)=>{this.googleSheetsDbService.get("Payments",this.paymentsAttributesMapping).subscribe({next:s=>{t(s)},error:s=>{e(s)}})})})}RefreshExpensesData(){return o(this,null,function*(){return new Promise((t,e)=>{this.googleSheetsDbService.get("Expenses",this.expensesAttributesMapping).subscribe({next:s=>{t(s)},error:s=>{e(s)}})})})}FetchClubSettings(t){return o(this,null,function*(){return this.googleSheetsDbService.spreadsheetId=t,new Promise((e,s)=>{this.googleSheetsDbService.get("Settings",this.clubSettingsAttributesMapping).subscribe({next:a=>{console.log("Raw club settings data fetched:",a);let i={clubId:"",clubName:"",adminEmail:"",currency:"",latePaymentDays:0,apiToken:"",apiUrl:"",version:"",lastUpdated:"",attendanceLastUpdated:"",membersLastUpdated:"",paymentsLastUpdated:"",expensesLastUpdated:""};a.forEach(r=>{r.settings==="ClubId"&&(i.clubId=r.value||""),r.settings==="Club Name"&&(i.clubName=r.value||""),r.settings==="Admin Email"&&(i.adminEmail=r.value||""),r.settings==="Currency"&&(i.currency=r.value||""),r.settings==="Late Payment Days"&&(i.latePaymentDays=parseInt(r.value||"0")),r.settings==="API Token"&&(i.apiToken=r.value||""),r.settings==="API URL"&&(i.apiUrl=r.value||""),r.settings==="Version"&&(i.version=r.value||""),r.settings==="Last Updated"&&(i.lastUpdated=r.value||""),r.settings==="Attendance Last Updated"&&(i.attendanceLastUpdated=r.value||""),r.settings==="Members Last Updated"&&(i.membersLastUpdated=r.value||""),r.settings==="Payments Last Updated"&&(i.paymentsLastUpdated=r.value||""),r.settings==="Expenses Last Updated"&&(i.expensesLastUpdated=r.value||"")}),e(i)},error:a=>{s(a)}})})})}RefreshAllData(){return o(this,null,function*(){yield this.RefreshMembersData(),yield this.RefreshAttendanceData(),yield this.RefreshPaymentsData(),yield this.RefreshExpensesData()})}};n.\u0275fac=function(e){return new(e||n)(d(f),d(g),d(y))},n.\u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"});let c=n;return c})();export{j as a};
