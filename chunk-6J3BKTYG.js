import{a as B}from"./chunk-2JW2NRRJ.js";import{a as O,e as W,f as z}from"./chunk-UERSP4CJ.js";import{a as m}from"./chunk-P5NOT2UF.js";import{B as f,Va as E,Wa as L,Xa as $,c as p,k as w,y as T}from"./chunk-7E5XZK2A.js";import{a as C,b as I,i as b}from"./chunk-OYAVQN5W.js";var _=(()=>{let h=class h{constructor(t,e,a,s){this.http=t,this.authService=e,this.clubContext=a,this.memberService=s,this.apiUrl=O.apiUrl,this.attendanceSubject=new p([]),this.analyticsSubject=new p(null),this.loadingSubject=new p(!1),this.lastSyncSubject=new p(null),this.attendance$=this.attendanceSubject.asObservable(),this.analytics$=this.analyticsSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.lastSync$=this.lastSyncSubject.asObservable(),this.attendanceSubject.next([]),this.analyticsSubject.next(null),this.loadingSubject.next(!1),this.lastSyncSubject.next(null),setTimeout(()=>this.loadCachedData(),1e3)}loadCachedData(){return b(this,null,function*(){try{console.log("Loading cached attendance data...");let t=yield m.getAll(),e=yield m.getLastSyncTime();console.log("Cached attendance records:",t.length),t.length>0&&(this.attendanceSubject.next(t),this.calculateAnalytics(t)),this.lastSyncSubject.next(e)}catch(t){console.error("Error loading cached data:",t)}})}initializeData(){return b(this,null,function*(){try{this.loadingSubject.next(!0),yield this.loadCachedData();let t=yield m.getLastSyncTime();(this.attendanceSubject.value.length===0||!t||new Date().getTime()-t.getTime()>5*60*1e3)&&this.syncAttendance().catch(a=>{console.error("Background sync failed:",a)})}catch(t){console.error("Error initializing attendance data:",t)}finally{this.loadingSubject.next(!1)}})}syncAttendance(t=!1){return b(this,null,function*(){var e;try{this.loadingSubject.next(!0);let a=yield this.authService.getAuthToken(),s=this.clubContext.getSportsClubId()||"";console.log("Attendance sync - Token:",a?"Present":"Missing"),console.log("Attendance sync - Club ID:",s);let r={};if(!t){let l=yield m.getLastAttendanceId();l&&(r.lastAttendanceId=l)}let c=new L().set("action","getAttendance").set("sportsClubId",s).set("authorization",a?"Bearer "+a:"");Object.keys(r).length>0&&(c=c.set("payload",JSON.stringify(r)));let A={headers:new E({"Content-Type":"text/plain;charset=utf-8"}),params:c,responseType:"json",observe:"body"},o=yield this.http.get(this.apiUrl,A).toPromise();if((o==null?void 0:o.status)==="error")throw new Error(((e=o.error)==null?void 0:e.message)||"API returned error status");if((o==null?void 0:o.status)==="success"&&o.data){let l=Array.isArray(o.data)?o.data:[o.data];if(l=yield this.linkWithMemberData(l),t||!(yield m.getLastAttendanceId())?yield m.setAll(l):yield m.addRecords(l),l.length>0){let S=Math.max(...l.map(M=>parseInt(M.id||"0"))).toString();yield m.setLastAttendanceId(S)}yield m.setLastSyncTime(new Date),this.lastSyncSubject.next(new Date),this.clubContext.setLastAttendanceRefresh(new Date);let y=yield m.getAll();this.attendanceSubject.next(y),this.calculateAnalytics(y)}}catch(a){throw console.error("Error syncing attendance:",a),a}finally{this.loadingSubject.next(!1)}})}linkWithMemberData(t){return b(this,null,function*(){try{console.log("Linking attendance records with member data:",t.length);let e=yield new Promise((s,r)=>{let c=setTimeout(()=>{console.warn("Member service timeout, proceeding without member data"),s([])},5e3);this.memberService.getMembers().subscribe({next:d=>{clearTimeout(c),console.log("Members fetched for linking:",d.members.length),s(d.members)},error:d=>{clearTimeout(c),console.error("Error fetching members:",d),s([])}})}),a=new Map(e.map(s=>[s.id,s]));return console.log("Member map created with",a.size,"members"),t.map(s=>{let r=a.get(s.memberId),c=I(C({},s),{memberName:r?`${r.firstName} ${r.lastName}`.trim():"Unknown Member",membershipStatus:s.membershipStatus||"unknown"});return!r&&e.length>0&&console.warn("Member not found for attendance record:",s.memberId),c})}catch(e){return console.error("Error linking member data:",e),t}})}getFilteredAttendance(t){return this.attendance$.pipe(w(e=>this.applyFilters(e,t)))}applyFilters(t,e){let a=[...t];if(e.startDate&&(a=a.filter(s=>new Date(s.date)>=e.startDate)),e.endDate&&(a=a.filter(s=>new Date(s.date)<=e.endDate)),e.memberId&&(a=a.filter(s=>s.memberId===e.memberId)),e.membershipStatus&&e.membershipStatus!=="all"&&(a=a.filter(s=>s.membershipStatus===e.membershipStatus)),e.searchTerm){let s=e.searchTerm.toLowerCase();a=a.filter(r=>{var c,d;return((c=r.memberName)==null?void 0:c.toLowerCase().includes(s))||((d=r.notes)==null?void 0:d.toLowerCase().includes(s))})}return a}calculateAnalytics(t){var k;if(t.length===0){this.analyticsSubject.next(null);return}let e=new Map,a=new Map,s=new Map;t.forEach(n=>{let i=new Date(n.date).toDateString(),g=new Date(n.checkInTime).getHours();e.has(i)||e.set(i,{date:i,totalCheckins:0,activeMembers:0,expiredMembers:0,averageDuration:0,uniqueMembers:0});let u=e.get(i);u.totalCheckins++,n.membershipStatus==="active"?u.activeMembers++:n.membershipStatus==="expired"&&u.expiredMembers++,n.duration&&(u.averageDuration=(u.averageDuration+n.duration)/2),a.has(n.memberId)||a.set(n.memberId,new Set),a.get(n.memberId).add(i),s.set(g,(s.get(g)||0)+1)}),e.forEach((n,i)=>{let g=0;a.forEach(u=>{u.has(i)&&g++}),n.uniqueMembers=g});let r=Array.from(e.values()).sort((n,i)=>new Date(n.date).getTime()-new Date(i.date).getTime()),c=r.map(n=>n.totalCheckins),d=a.size,A=c.reduce((n,i)=>n+i,0)/c.length||0,o=Math.min(...c)||0,l=Math.max(...c)||0,y=t.filter(n=>n.membershipStatus==="active").length,S=t.filter(n=>n.membershipStatus==="expired").length,M=S>0?y/S:y,j=new Map;r.forEach(n=>{let i=new Date(n.date).toLocaleDateString("en-US",{weekday:"long"});j.set(i,(j.get(i)||0)+n.totalCheckins)});let H=((k=Array.from(j.entries()).sort((n,i)=>i[1]-n[1])[0])==null?void 0:k[0])||"Monday",x=r.slice(-14),v=x.slice(0,7).reduce((n,i)=>n+i.totalCheckins,0),R=x.slice(7,14).reduce((n,i)=>n+i.totalCheckins,0),U=v>0?(R-v)/v*100:0,N=Array.from(s.entries()).map(([n,i])=>({hour:n,count:i})).sort((n,i)=>i.count-n.count).slice(0,5),P={dailyStats:r,summary:{totalActiveUsers:d,averageDaily:Math.round(A*100)/100,minDaily:o,maxDaily:l,activeVsExpiredRatio:Math.round(M*100)/100,totalAttendanceRecords:t.length},trends:{weeklyGrowth:Math.round(U*100)/100,mostActiveDay:H,peakHours:N}};this.analyticsSubject.next(P)}refreshData(){return b(this,null,function*(){yield this.syncAttendance(!0)})}loadData(){return b(this,null,function*(){yield this.initializeData()})}getAttendanceByMember(t){return this.attendance$.pipe(w(e=>e.filter(a=>String(a.memberId)===t)))}getAttendanceByDateRange(t,e){return this.attendance$.pipe(w(a=>a.filter(s=>{let r=new Date(s.date);return r>=t&&r<=e})))}};h.\u0275fac=function(e){return new(e||h)(f($),f(W),f(z),f(B))},h.\u0275prov=T({token:h,factory:h.\u0275fac,providedIn:"root"});let D=h;return D})();export{_ as a};
