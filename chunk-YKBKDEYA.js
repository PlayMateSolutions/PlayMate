import{a as L}from"./chunk-SWDBMSAS.js";import{a as E}from"./chunk-UWHUA5XG.js";import{a as l}from"./chunk-4CL3V5QY.js";import{a as C,e as I,f as T}from"./chunk-HLDYDQ4G.js";import{C as u,Za as k,c as g,k as S,z as A}from"./chunk-CCDMTYGH.js";import{a as j,b as x,i as d}from"./chunk-OYAVQN5W.js";var Z=(()=>{let m=class m{constructor(a,e,t,i,r){this.http=a,this.authService=e,this.clubContext=t,this.memberService=i,this.googleSheetService=r,this.apiUrl=C.apiUrl,this.attendanceSubject=new g([]),this.analyticsSubject=new g(null),this.loadingSubject=new g(!1),this.lastSyncSubject=new g(null),this.attendance$=this.attendanceSubject.asObservable(),this.analytics$=this.analyticsSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.lastSync$=this.lastSyncSubject.asObservable(),this.attendanceSubject.next([]),this.analyticsSubject.next(null),this.loadingSubject.next(!1),this.lastSyncSubject.next(null),setTimeout(()=>this.loadCachedData(),1e3)}loadCachedData(){return d(this,null,function*(){try{console.log("Loading cached attendance data...");let a=yield l.getAll(),e=yield l.getLastSyncTime();console.log("Cached attendance records:",a.length),a.length>0&&(this.attendanceSubject.next(a),this.calculateAnalytics(a)),this.lastSyncSubject.next(e)}catch(a){console.error("Error loading cached data:",a)}})}initializeData(){return d(this,null,function*(){try{this.loadingSubject.next(!0),yield this.loadCachedData();let a=yield l.getLastSyncTime();(this.attendanceSubject.value.length===0||!a||new Date().getTime()-a.getTime()>5*60*1e3)&&this.syncAttendance(!0).catch(t=>{console.error("Background sync failed:",t)})}catch(a){console.error("Error initializing attendance data:",a)}finally{this.loadingSubject.next(!1)}})}syncAttendance(a=!1){return d(this,null,function*(){try{this.loadingSubject.next(!0),console.log("Fetching attendance data from Google Sheets...");let e=yield this.googleSheetService.RefreshAttendanceData(),t=yield this.linkWithMemberData(e);if(a||!(yield l.getLastAttendanceId())?yield l.setAll(t):yield l.addRecords(t),yield l.setLastSyncTime(new Date),this.lastSyncSubject.next(new Date),this.clubContext.setLastAttendanceRefresh(new Date),t.length>0){let i=Math.max(...t.map(r=>parseInt(r.id||"0"))).toString();yield l.setLastAttendanceId(i)}this.attendanceSubject.next(t),this.calculateAnalytics(t),console.log("Successfully synced attendance data from Google Sheets")}catch(e){throw console.error("Error syncing attendance:",e),e}finally{this.loadingSubject.next(!1)}})}linkWithMemberData(a){return d(this,null,function*(){try{console.log("Linking attendance records with member data:",a.length);let e=yield new Promise((i,r)=>{let c=setTimeout(()=>{console.warn("Member service timeout, proceeding without member data"),i([])},5e3);this.memberService.getMembers().subscribe({next:o=>{clearTimeout(c),console.log("Members fetched for linking:",o.members.length),i(o.members)},error:o=>{clearTimeout(c),console.error("Error fetching members:",o),i([])}})}),t=new Map(e.map(i=>[i.id,i]));return console.log("Member map created with",t.size,"members"),a.map(i=>{let r=t.get(i.memberId),c=x(j({},i),{memberName:r?`${r.firstName} ${r.lastName}`.trim():"Unknown Member",membershipStatus:i.membershipStatus||"unknown"});return!r&&e.length>0&&console.warn("Member not found for attendance record:",i.memberId),c})}catch(e){return console.error("Error linking member data:",e),a}})}getFilteredAttendance(a){return this.attendance$.pipe(S(e=>this.applyFilters(e,a)))}applyFilters(a,e){let t=[...a];if(e.startDate&&(t=t.filter(i=>new Date(i.date)>=e.startDate)),e.endDate&&(t=t.filter(i=>new Date(i.date)<=e.endDate)),e.memberId&&(t=t.filter(i=>i.memberId===e.memberId)),e.membershipStatus&&e.membershipStatus!=="all"&&(t=t.filter(i=>i.membershipStatus===e.membershipStatus)),e.searchTerm){let i=e.searchTerm.toLowerCase();t=t.filter(r=>{var c,o;return((c=r.memberName)==null?void 0:c.toLowerCase().includes(i))||((o=r.notes)==null?void 0:o.toLowerCase().includes(i))})}return t}calculateAnalytics(a){var v;if(a.length===0){this.analyticsSubject.next(null);return}let e=new Map,t=new Map,i=new Map;a.forEach(n=>{let s=new Date(n.date).toDateString(),b=new Date(n.checkInTime).getHours();e.has(s)||e.set(s,{date:s,totalCheckins:0,activeMembers:0,expiredMembers:0,averageDuration:0,uniqueMembers:0});let h=e.get(s);h.totalCheckins++,n.membershipStatus==="active"?h.activeMembers++:n.membershipStatus==="expired"&&h.expiredMembers++,n.duration&&(h.averageDuration=(h.averageDuration+n.duration)/2),t.has(n.memberId)||t.set(n.memberId,new Set),t.get(n.memberId).add(s),i.set(b,(i.get(b)||0)+1)}),e.forEach((n,s)=>{let b=0;t.forEach(h=>{h.has(s)&&b++}),n.uniqueMembers=b});let r=Array.from(e.values()).sort((n,s)=>new Date(n.date).getTime()-new Date(s.date).getTime()),c=r.map(n=>n.totalCheckins),o=t.size,$=c.reduce((n,s)=>n+s,0)/c.length||0,R=Math.min(...c)||0,W=Math.max(...c)||0,w=a.filter(n=>n.membershipStatus==="active").length,D=a.filter(n=>n.membershipStatus==="expired").length,F=D>0?w/D:w,f=new Map;r.forEach(n=>{let s=new Date(n.date).toLocaleDateString("en-US",{weekday:"long"});f.set(s,(f.get(s)||0)+n.totalCheckins)});let G=((v=Array.from(f.entries()).sort((n,s)=>s[1]-n[1])[0])==null?void 0:v[0])||"Monday",M=r.slice(-14),p=M.slice(0,7).reduce((n,s)=>n+s.totalCheckins,0),O=M.slice(7,14).reduce((n,s)=>n+s.totalCheckins,0),z=p>0?(O-p)/p*100:0,B=Array.from(i.entries()).map(([n,s])=>({hour:n,count:s})).sort((n,s)=>s.count-n.count).slice(0,5),U={dailyStats:r,summary:{totalActiveUsers:o,averageDaily:Math.round($*100)/100,minDaily:R,maxDaily:W,activeVsExpiredRatio:Math.round(F*100)/100,totalAttendanceRecords:a.length},trends:{weeklyGrowth:Math.round(z*100)/100,mostActiveDay:G,peakHours:B}};this.analyticsSubject.next(U)}refreshData(){return d(this,null,function*(){yield this.syncAttendance(!0)})}loadData(){return d(this,null,function*(){yield this.initializeData()})}getAttendanceByMember(a){return this.attendance$.pipe(S(e=>e.filter(t=>String(t.memberId)===a)))}getAttendanceByDateRange(a,e){return this.attendance$.pipe(S(t=>t.filter(i=>{let r=new Date(i.date);return r>=a&&r<=e})))}};m.\u0275fac=function(e){return new(e||m)(u(k),u(I),u(T),u(L),u(E))},m.\u0275prov=A({token:m,factory:m.\u0275fac,providedIn:"root"});let y=m;return y})();export{Z as a};
