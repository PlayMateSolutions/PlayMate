import{a as be}from"./chunk-J35THJEI.js";import{a as me,c as he}from"./chunk-5OSSL34O.js";import{a as pe,w as fe}from"./chunk-5OPRJA25.js";import{a as ue,e as ge,f as ye}from"./chunk-HFWA7D7K.js";import{$ as f,$b as oe,A as E,Eb as Q,Fb as X,Gb as Y,Hb as Z,Ia as U,Ib as ee,Jb as te,Lb as ae,Ma as W,Ob as ne,Pa as G,Q as S,Qa as V,R as L,Ra as J,T as F,X as B,Xb as re,Z as D,aa as p,ba as C,c as j,cc as ie,dc as se,ec as ce,ha as H,ia as R,j as O,jb as K,mc as le,oc as de,ra as w,ta as _,x as z}from"./chunk-YLMXCQX3.js";import"./chunk-GRX4ZZSO.js";import"./chunk-7KGURMOZ.js";import"./chunk-T47TWMLD.js";import"./chunk-Y2YV2HED.js";import"./chunk-EDCKRRWH.js";import"./chunk-SPCCATGZ.js";import"./chunk-YKMIF4NY.js";import"./chunk-YVBCZ55L.js";import"./chunk-4U6PRYVA.js";import"./chunk-FXFZIWDD.js";import"./chunk-CSG5OQLY.js";import"./chunk-VMHM3MLJ.js";import"./chunk-D5MTWDX2.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{a as A,b as x,i as h}from"./chunk-OYAVQN5W.js";var y=(()=>{let r=class r{static openDB(){return new Promise((e,t)=>{let a=indexedDB.open(r.dbName,r.version);a.onupgradeneeded=n=>{let o=n.target.result;if(!o.objectStoreNames.contains(r.storeName)){let s=o.createObjectStore(r.storeName,{keyPath:"id"});s.createIndex("memberId","memberId",{unique:!1}),s.createIndex("date","date",{unique:!1}),s.createIndex("membershipStatus","membershipStatus",{unique:!1}),s.createIndex("dateRange",["date","memberId"],{unique:!1})}},a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)})}static getAll(){return h(this,null,function*(){let e=yield r.openDB();return new Promise((t,a)=>{let s=e.transaction(r.storeName,"readonly").objectStore(r.storeName).getAll();s.onsuccess=()=>{let c=s.result.map(l=>x(A({},l),{date:new Date(l.date),checkInTime:new Date(l.checkInTime),checkOutTime:l.checkOutTime?new Date(l.checkOutTime):void 0}));t(c)},s.onerror=()=>a(s.error)})})}static setAll(e){return h(this,null,function*(){let t=yield r.openDB();return new Promise((a,n)=>{var u;let o=t.transaction(r.storeName,"readwrite"),s=o.objectStore(r.storeName);s.clear();for(let c of e){let l=x(A({},c),{id:(u=c.id)!=null?u:c.ID,date:new Date(c.date),checkInTime:new Date(c.checkInTime),checkOutTime:c.checkOutTime?new Date(c.checkOutTime):void 0});s.put(l)}o.oncomplete=()=>a(),o.onerror=()=>n(o.error)})})}static addRecords(e){return h(this,null,function*(){let t=yield r.openDB();return new Promise((a,n)=>{var u;let o=t.transaction(r.storeName,"readwrite"),s=o.objectStore(r.storeName);for(let c of e){let l=x(A({},c),{id:(u=c.id)!=null?u:c.ID,date:new Date(c.date),checkInTime:new Date(c.checkInTime),checkOutTime:c.checkOutTime?new Date(c.checkOutTime):void 0});s.put(l)}o.oncomplete=()=>a(),o.onerror=()=>n(o.error)})})}static getByDateRange(e,t){return h(this,null,function*(){let a=yield r.openDB();return new Promise((n,o)=>{let c=a.transaction(r.storeName,"readonly").objectStore(r.storeName).index("date"),l=IDBKeyRange.bound(e,t),g=c.getAll(l);g.onsuccess=()=>{let k=g.result.map(I=>x(A({},I),{date:new Date(I.date),checkInTime:new Date(I.checkInTime),checkOutTime:I.checkOutTime?new Date(I.checkOutTime):void 0}));n(k)},g.onerror=()=>o(g.error)})})}static getByMemberId(e){return h(this,null,function*(){let t=yield r.openDB();return new Promise((a,n)=>{let c=t.transaction(r.storeName,"readonly").objectStore(r.storeName).index("memberId").getAll(e);c.onsuccess=()=>{let g=c.result.map(b=>x(A({},b),{date:new Date(b.date),checkInTime:new Date(b.checkInTime),checkOutTime:b.checkOutTime?new Date(b.checkOutTime):void 0}));a(g)},c.onerror=()=>n(c.error)})})}static getLastAttendanceId(){return h(this,null,function*(){try{return localStorage.getItem("playmate_lastAttendanceId")}catch(e){return console.error("Error getting last attendance ID from localStorage:",e),null}})}static setLastAttendanceId(e){return h(this,null,function*(){try{localStorage.setItem("playmate_lastAttendanceId",e)}catch(t){throw console.error("Error setting last attendance ID to localStorage:",t),t}})}static getLastSyncTime(){return h(this,null,function*(){try{let e=localStorage.getItem("playmate_lastSyncTime");return e?new Date(e):null}catch(e){return console.error("Error getting last sync time from localStorage:",e),null}})}static setLastSyncTime(e){return h(this,null,function*(){try{localStorage.setItem("playmate_lastSyncTime",e.toISOString())}catch(t){throw console.error("Error setting last sync time to localStorage:",t),t}})}static clearSettings(){try{localStorage.removeItem("playmate_lastAttendanceId"),localStorage.removeItem("playmate_lastSyncTime")}catch(e){console.error("Error clearing attendance settings from localStorage:",e)}}};r.dbName="PlayMateDB",r.storeName="attendance",r.version=2;let d=r;return d})();var Se=(()=>{let r=class r{constructor(e,t,a,n){this.http=e,this.authService=t,this.clubContext=a,this.memberService=n,this.apiUrl=ue.apiUrl,this.attendanceSubject=new j([]),this.analyticsSubject=new j(null),this.loadingSubject=new j(!1),this.lastSyncSubject=new j(null),this.attendance$=this.attendanceSubject.asObservable(),this.analytics$=this.analyticsSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.lastSync$=this.lastSyncSubject.asObservable(),this.attendanceSubject.next([]),this.analyticsSubject.next(null),this.loadingSubject.next(!1),this.lastSyncSubject.next(null),setTimeout(()=>this.loadCachedData(),1e3)}loadCachedData(){return h(this,null,function*(){try{console.log("Loading cached attendance data...");let e=yield y.getAll(),t=yield y.getLastSyncTime();console.log("Cached attendance records:",e.length),e.length>0&&(this.attendanceSubject.next(e),this.calculateAnalytics(e)),this.lastSyncSubject.next(t)}catch(e){console.error("Error loading cached data:",e)}})}initializeData(){return h(this,null,function*(){try{this.loadingSubject.next(!0),yield this.loadCachedData();let e=yield y.getLastSyncTime();(this.attendanceSubject.value.length===0||!e||new Date().getTime()-e.getTime()>5*60*1e3)&&this.syncAttendance().catch(a=>{console.error("Background sync failed:",a)})}catch(e){console.error("Error initializing attendance data:",e)}finally{this.loadingSubject.next(!1)}})}syncAttendance(e=!1){return h(this,null,function*(){var t;try{this.loadingSubject.next(!0);let a=yield this.authService.getAuthToken(),n=this.clubContext.getSportsClubId()||"";console.log("Attendance sync - Token:",a?"Present":"Missing"),console.log("Attendance sync - Club ID:",n);let o={};if(!e){let g=yield y.getLastAttendanceId();g&&(o.lastAttendanceId=g)}let s=new V().set("action","getAttendance").set("sportsClubId",n).set("authorization",a?"Bearer "+a:"");Object.keys(o).length>0&&(s=s.set("payload",JSON.stringify(o)));let c={headers:new G({"Content-Type":"text/plain;charset=utf-8"}),params:s,responseType:"json",observe:"body"},l=yield this.http.get(this.apiUrl,c).toPromise();if((l==null?void 0:l.status)==="error")throw new Error(((t=l.error)==null?void 0:t.message)||"API returned error status");if((l==null?void 0:l.status)==="success"&&l.data){let g=Array.isArray(l.data)?l.data:[l.data];if(g=yield this.linkWithMemberData(g),e||!(yield y.getLastAttendanceId())?yield y.setAll(g):yield y.addRecords(g),g.length>0){let k=Math.max(...g.map(I=>parseInt(I.id||"0"))).toString();yield y.setLastAttendanceId(k)}yield y.setLastSyncTime(new Date),this.lastSyncSubject.next(new Date);let b=yield y.getAll();this.attendanceSubject.next(b),this.calculateAnalytics(b)}}catch(a){throw console.error("Error syncing attendance:",a),a}finally{this.loadingSubject.next(!1)}})}linkWithMemberData(e){return h(this,null,function*(){try{console.log("Linking attendance records with member data:",e.length);let t=yield new Promise((n,o)=>{let s=setTimeout(()=>{console.warn("Member service timeout, proceeding without member data"),n([])},5e3);this.memberService.getMembers().subscribe({next:u=>{clearTimeout(s),console.log("Members fetched for linking:",u.members.length),n(u.members)},error:u=>{clearTimeout(s),console.error("Error fetching members:",u),n([])}})}),a=new Map(t.map(n=>[n.id,n]));return console.log("Member map created with",a.size,"members"),e.map(n=>{let o=a.get(n.memberId),s=x(A({},n),{memberName:o?`${o.firstName} ${o.lastName}`.trim():"Unknown Member",membershipStatus:n.membershipStatus||"unknown"});return!o&&t.length>0&&console.warn("Member not found for attendance record:",n.memberId),s})}catch(t){return console.error("Error linking member data:",t),e}})}getFilteredAttendance(e){return this.attendance$.pipe(O(t=>this.applyFilters(t,e)))}applyFilters(e,t){let a=[...e];if(t.startDate&&(a=a.filter(n=>new Date(n.date)>=t.startDate)),t.endDate&&(a=a.filter(n=>new Date(n.date)<=t.endDate)),t.memberId&&(a=a.filter(n=>n.memberId===t.memberId)),t.membershipStatus&&t.membershipStatus!=="all"&&(a=a.filter(n=>n.membershipStatus===t.membershipStatus)),t.searchTerm){let n=t.searchTerm.toLowerCase();a=a.filter(o=>{var s,u;return((s=o.memberName)==null?void 0:s.toLowerCase().includes(n))||((u=o.notes)==null?void 0:u.toLowerCase().includes(n))})}return a}calculateAnalytics(e){var $;if(e.length===0){this.analyticsSubject.next(null);return}let t=new Map,a=new Map,n=new Map;e.forEach(i=>{let m=new Date(i.date).toDateString(),M=new Date(i.checkInTime).getHours();t.has(m)||t.set(m,{date:m,totalCheckins:0,activeMembers:0,expiredMembers:0,averageDuration:0,uniqueMembers:0});let v=t.get(m);v.totalCheckins++,i.membershipStatus==="active"?v.activeMembers++:i.membershipStatus==="expired"&&v.expiredMembers++,i.duration&&(v.averageDuration=(v.averageDuration+i.duration)/2),a.has(i.memberId)||a.set(i.memberId,new Set),a.get(i.memberId).add(m),n.set(M,(n.get(M)||0)+1)}),t.forEach((i,m)=>{let M=0;a.forEach(v=>{v.has(m)&&M++}),i.uniqueMembers=M});let o=Array.from(t.values()).sort((i,m)=>new Date(i.date).getTime()-new Date(m.date).getTime()),s=o.map(i=>i.totalCheckins),u=a.size,c=s.reduce((i,m)=>i+m,0)/s.length||0,l=Math.min(...s)||0,g=Math.max(...s)||0,b=e.filter(i=>i.membershipStatus==="active").length,k=e.filter(i=>i.membershipStatus==="expired").length,I=k>0?b/k:b,P=new Map;o.forEach(i=>{let m=new Date(i.date).toLocaleDateString("en-US",{weekday:"long"});P.set(m,(P.get(m)||0)+i.totalCheckins)});let De=(($=Array.from(P.entries()).sort((i,m)=>m[1]-i[1])[0])==null?void 0:$[0])||"Monday",q=o.slice(-14),N=q.slice(0,7).reduce((i,m)=>i+m.totalCheckins,0),we=q.slice(7,14).reduce((i,m)=>i+m.totalCheckins,0),Ie=N>0?(we-N)/N*100:0,Ae=Array.from(n.entries()).map(([i,m])=>({hour:i,count:m})).sort((i,m)=>m.count-i.count).slice(0,5),xe={dailyStats:o,summary:{totalActiveUsers:u,averageDaily:Math.round(c*100)/100,minDaily:l,maxDaily:g,activeVsExpiredRatio:Math.round(I*100)/100,totalAttendanceRecords:e.length},trends:{weeklyGrowth:Math.round(Ie*100)/100,mostActiveDay:De,peakHours:Ae}};this.analyticsSubject.next(xe)}refreshData(){return h(this,null,function*(){yield this.syncAttendance(!0)})}loadData(){return h(this,null,function*(){yield this.initializeData()})}getAttendanceByMember(e){return this.attendance$.pipe(O(t=>t.filter(a=>a.memberId===e)))}getAttendanceByDateRange(e,t){return this.attendance$.pipe(O(a=>a.filter(n=>{let o=new Date(n.date);return o>=e&&o<=t})))}};r.\u0275fac=function(t){return new(t||r)(E(J),E(ge),E(ye),E(be))},r.\u0275prov=z({token:r,factory:r.\u0275fac,providedIn:"root"});let d=r;return d})();function ke(d,r){d&1&&C(0,"ion-spinner",10)}function Ce(d,r){d&1&&C(0,"ion-icon",11)}function Me(d,r){d&1&&(f(0,"div",12),C(1,"ion-spinner",10),f(2,"ion-text",13),w(3,"Loading attendance data..."),p()())}function je(d,r){if(d&1&&(f(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),w(3,"Attendance Summary"),p()(),f(4,"ion-card-content")(5,"p")(6,"strong"),w(7,"Total Records:"),p(),w(8),p(),f(9,"p")(10,"strong"),w(11,"Days with Data:"),p(),w(12),p()()()),d&2){let T=R();S(8),_(" ",T.totalRecords,""),S(4),_(" ",T.chartData.length,"")}}function Ee(d,r){if(d&1&&(f(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),w(3,"Daily Attendance (Last 30 Days)"),p()(),f(4,"ion-card-content")(5,"div",14),C(6,"google-chart",15),p()()()),d&2){let T=R();S(6),D("type",T.chartType)("data",T.chartData)("columns",T.chartColumns)("options",T.chartOptions)("height",300)}}function Oe(d,r){d&1&&(f(0,"ion-card")(1,"ion-card-content",16)(2,"ion-text",13)(3,"h3"),w(4,"No attendance data found"),p(),f(5,"p"),w(6,"There are no attendance records to display."),p()()()())}var et=(()=>{let r=class r{constructor(e,t){this.attendanceService=e,this.toastController=t,this.loading=!0,this.refreshing=!1,this.dailyData=[],this.chartData=[],this.chartColumns=["Date","Attendance"],this.chartType=me.ColumnChart,this.chartOptions={backgroundColor:"transparent",colors:["#4CAF50"],chartArea:{left:60,top:20,width:"85%",height:"75%"},hAxis:{textStyle:{fontSize:12,color:"#666"},gridlines:{color:"transparent"}},vAxis:{textStyle:{fontSize:12,color:"#666"},gridlines:{color:"#e0e0e0",count:5},minValue:0},legend:{position:"none"},animation:{startup:!0,duration:1e3,easing:"out"}},this.totalRecords=0,pe({refresh:fe})}ngOnInit(){this.loadAttendanceData()}loadAttendanceData(){return h(this,null,function*(){try{this.loading=!0,console.log("Loading attendance data from IndexedDB...");let e=yield y.getAll();console.log("Loaded records:",e.length),this.totalRecords=e.length,this.dailyData=this.calculateDailyAttendance(e),this.chartData=this.prepareChartData(this.dailyData),this.chartData.length===0&&(console.log("No real data found, adding test data..."),this.chartData=[["Aug 20",15],["Aug 21",23],["Aug 22",18],["Aug 23",31],["Aug 24",27]],this.totalRecords=5),console.log("Daily data:",this.dailyData),console.log("Chart data:",this.chartData)}catch(e){console.error("Error loading attendance data:",e)}finally{this.loading=!1}})}calculateDailyAttendance(e){let t=new Map;return e.forEach(a=>{let n=new Date(a.date).toISOString().split("T")[0];t.set(n,(t.get(n)||0)+1)}),Array.from(t.entries()).map(([a,n])=>({date:a,count:n})).sort((a,n)=>a.date.localeCompare(n.date)).slice(-30)}prepareChartData(e){return e.map(t=>[this.formatDate(t.date),t.count])}formatDate(e){return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})}refreshAttendance(){return h(this,null,function*(){try{this.refreshing=!0,console.log("Refreshing attendance data..."),yield this.attendanceService.syncAttendance(!1),yield this.loadAttendanceData(),console.log("Attendance data refreshed successfully"),yield(yield this.toastController.create({message:"Attendance data refreshed successfully",duration:3e3,color:"success",position:"top"})).present()}catch(e){console.error("Error refreshing attendance data:",e),yield(yield this.toastController.create({message:"Failed to refresh attendance data",duration:3e3,color:"danger",position:"top"})).present()}finally{this.refreshing=!1}})}};r.\u0275fac=function(t){return new(t||r)(L(Se),L(le))},r.\u0275cmp=F({type:r,selectors:[["app-attendance"]],decls:15,vars:9,consts:[[3,"translucent"],["color","primary"],["slot","start"],["slot","end"],[3,"click","disabled"],["name","crescent",4,"ngIf"],["name","refresh","slot","icon-only",4,"ngIf"],[3,"fullscreen"],["class","loading-container",4,"ngIf"],[4,"ngIf"],["name","crescent"],["name","refresh","slot","icon-only"],[1,"loading-container"],["color","medium"],[2,"display","flex","justify-content","center","align-items","center"],[3,"type","data","columns","options","height"],[1,"no-data"]],template:function(t,a){t&1&&(f(0,"ion-header",0)(1,"ion-toolbar",1)(2,"ion-buttons",2),C(3,"ion-menu-button"),p(),f(4,"ion-title"),w(5,"Daily Attendance"),p(),f(6,"ion-buttons",3)(7,"ion-button",4),H("click",function(){return a.refreshAttendance()}),B(8,ke,1,0,"ion-spinner",5)(9,Ce,1,0,"ion-icon",6),p()()()(),f(10,"ion-content",7),B(11,Me,4,0,"div",8)(12,je,13,2,"ion-card",9)(13,Ee,7,5,"ion-card",9)(14,Oe,7,0,"ion-card",9),p()),t&2&&(D("translucent",!0),S(7),D("disabled",a.loading||a.refreshing),S(),D("ngIf",a.refreshing),S(),D("ngIf",!a.refreshing),S(),D("fullscreen",!0),S(),D("ngIf",a.loading),S(),D("ngIf",!a.loading),S(),D("ngIf",!a.loading&&a.chartData.length>0),S(),D("ngIf",!a.loading&&a.chartData.length===0))},dependencies:[W,U,K,ne,ce,se,ae,Y,ee,te,Z,oe,ie,X,re,Q,de,he],styles:[".loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;gap:1rem}.no-data[_ngcontent-%COMP%]{text-align:center;padding:2rem}.no-data[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:var(--ion-color-medium);margin-bottom:.5rem}.no-data[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--ion-color-medium-tint)}"]});let d=r;return d})();export{et as AttendancePage};
